SET DATEFORMAT dmy 
SELECT '07', D.DivisionArea, D.UpperDivisionName, D.DivisionCode, COUNT(Temp01.ApplicationNo30191) AS ApplicationNo30191, SUM(Temp01.UnitPremium30191) AS UnitPremium30191, SUM(0) AS ApplicationNo20201, SUM(0) AS UnitPremium20101, COUNT(Temp01.NotifyApplicationNo30191) AS NotifyApplicationNo30191, SUM(Temp01.notifyUnitPremium30191) as notifyUnitPremium30191, SUM(0) AS NotifyApplicationNo20101, SUM(0) as notifyUnitPremium20101, COUNT(Temp01.RejectApplicationNo30191) as RejectApplicationNo30191, SUM(Temp01.RejectUnitPremium30191) as RejectUnitPremium30191, 
SUM(0) as RejectApplicationNo20101, SUM(0) as RejectUnitPremium20101 
FROM Division D LEFT JOIN ( SELECT G.BranchCode, G.UnitPremium AS UnitPremium30191, G.ApplicationNo AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20201, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101 FROM [GroupInsuranceMember] G 
WHERE (G.PlanCode = '30191') AND (G.MatchingID IS NOT NULL) 
AND (G.DepositeDate>='01/07/2015 00:00:00.000' AND G.DepositeDate<='31/07/2015 23:59:59.997') 
UNION ALL SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20201, G.TotalPremium AS notifyUnitPremium30191, G.ApplicationNo AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101 FROM Notify G WHERE (G.MatchingID IS NOT NULL) 
AND (G.PayDate>='01/07/2015 00:00:00.000' AND G.PayDate<='31/07/2015 23:59:59.997') UNION ALL SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20201, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, G.ApplicationNo AS RejectApplicationNo30191, G.UnitPremium AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101 FROM [GroupInsuranceMember] G WHERE (G.PlanCode = '30191') AND (G.ApproveStatus > 2) 
AND (G.ApproveDate>='01/07/2015 00:00:00.000' AND G.ApproveDate<='31/07/2015 23:59:59.997') ) AS Temp01 ON Temp01.[BranchCode] = D.DivisionCode WHERE D.DivisionArea <> 0 AND SUBSTRING(D.DivisionCodeHR,5,1) <> 'A' AND SUBSTRING(D.DivisionCodeHR,3,2) <> '00' 
GROUP BY D.DivisionArea, D.UpperDivisionName, D.DivisionCode
WITH ROLLUP ORDER BY CAST(D.DivisionArea AS INT) , D.UpperDivisionName, D.DivisionCode


SET DATEFORMAT dmy CREATE TABLE #ResultALL01 ( BranchCode nvarchar(5) NULL, UnitPremium30191 int NULL, ApplicationNo30191 nvarchar(50) NULL, UnitPremium int NULL, ApplicationNo20101 nvarchar(50) NULL, notifyUnitPremium30191 int NULL, NotifyApplicationNo30191 nvarchar(50) NULL, NotifyUnitPremium20101 int NULL, NotifyApplicationNo20101 nvarchar(50) NULL, RejectApplicationNo30191 nvarchar(50) NULL, RejectUnitPremium30191 int NULL, RejectApplicationNo20101 nvarchar(50) NULL, RejectUnitPremium20101 int NULL, ApplicationMonth int NULL, Premium int NULL, Year1 int NULL, Lot1 int NULL, Year2 int NULL, Lot2 int NULL, PayFirstMonth int NULL) CREATE TABLE #ResultALL02 ( BranchCode nvarchar(5) NULL, UnitPremium30191 int NULL, ApplicationNo30191 nvarchar(50) NULL, UnitPremium int NULL, ApplicationNo20101 nvarchar(50) NULL, notifyUnitPremium30191 int NULL, NotifyApplicationNo30191 nvarchar(50) NULL, NotifyUnitPremium20101 int NULL, NotifyApplicationNo20101 nvarchar(50) NULL, RejectApplicationNo30191 nvarchar(50) NULL, RejectUnitPremium30191 int NULL, RejectApplicationNo20101 nvarchar(50) NULL, RejectUnitPremium20101 int NULL, ApplicationMonth int NULL, Premium int NULL, Year1 int NULL, Lot1 int NULL, Year2 int NULL, Lot2 int NULL ) CREATE TABLE #ResultTemp101 ( BranchCode nvarchar(5) NULL, UnitPremium30191 int NULL, ApplicationNo30191 nvarchar(50) NULL, UnitPremium int NULL, ApplicationNo20101 nvarchar(50) NULL, notifyUnitPremium30191 int NULL, NotifyApplicationNo30191 nvarchar(50) NULL, NotifyUnitPremium20101 int NULL, NotifyApplicationNo20101 nvarchar(50) NULL, RejectApplicationNo30191 nvarchar(50) NULL, RejectUnitPremium30191 int NULL, RejectApplicationNo20101 nvarchar(50) NULL, RejectUnitPremium20101 int NULL, ApplicationMonth int NULL, PremiumPerMonth int NULL) CREATE TABLE #ResultTemp201 ( BranchCode nvarchar(5) NULL, UnitPremium30191 int NULL, ApplicationNo30191 nvarchar(50) NULL, UnitPremium int NULL, ApplicationNo20101 nvarchar(50) NULL, notifyUnitPremium30191 int NULL, NotifyApplicationNo30191 nvarchar(50) NULL, NotifyUnitPremium20101 int NULL, NotifyApplicationNo20101 nvarchar(50) NULL, RejectApplicationNo30191 nvarchar(50) NULL, RejectUnitPremium30191 int NULL, RejectApplicationNo20101 nvarchar(50) NULL, RejectUnitPremium20101 int NULL, ApplicationMonth int NULL, PremiumPerMonth int NULL) INSERT INTO #ResultALL01 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, null AS ApplicationMonth, G.Premium AS Premium, G.Year1, G.lot1, G.Year2, G.Lot2, G.PayFirstMonth FROM PersonalInsuranceSaving G WHERE (G.MatchingID IS NOT NULL) AND (G.DepositeDate>='01/04/2015 00:00:00.000' AND G.DepositeDate<='30/04/2015 23:59:59.997') INSERT INTO #ResultALL02 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS NotifyUnitPremium20101, G.ApplicationNo AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, null AS ApplicationMonth, G.Premium AS Premium, G.Year1, G.lot1, G.Year2, G.Lot2 FROM NotifySaving G WHERE (G.MatchingID IS NOT NULL) AND (G.PayDate>='01/04/2015 00:00:00.000' AND G.PayDate<='30/04/2015 23:59:59.997') INSERT INTO #ResultTemp101 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, G.PayFirstMonth AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL01 G WHERE (G.Year1=1 AND G.Year2=1) INSERT INTO #ResultTemp101 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, 12 AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL01 G WHERE G.Year1=1 AND G.Year2=2 AND G.PayFirstMonth > 12 INSERT INTO #ResultTemp101 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, G.PayFirstMonth AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL01 G WHERE G.Year1=1 AND G.Year2=2 AND G.PayFirstMonth <= 12 INSERT INTO #ResultTemp101 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, 12 AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL01 G WHERE G.Year1=1 AND G.Year2=3 INSERT INTO #ResultTemp101 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, G.ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, 12 AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL01 G WHERE G.Year1=1 AND G.Year2>3 INSERT INTO #ResultTemp201 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, G.NotifyApplicationNo20101 AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, (G.Lot2-G.Lot1)+1 AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL02 G WHERE (G.Year1=1 AND G.Year2=1) INSERT INTO #ResultTemp201 SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, G.NotifyApplicationNo20101 AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, (12-G.Lot1)+1 AS ApplicationMonth, G.Premium AS PremiumPerMonth FROM #ResultALL02 G WHERE G.Year1=1 AND G.Year2<>1 SELECT D.DivisionArea, D.UpperDivisionName, D.DivisionName, SUM(0) AS ApplicationNo30191, SUM(0) AS UnitPremium30191, COUNT(Temp01.ApplicationNo20101) AS ApplicationNo20101, SUM(Temp01.UnitPremium20101) AS UnitPremium20101, SUM(0) AS NotifyApplicationNo30191, SUM(0) as notifyUnitPremium30191, COUNT(Temp01.NotifyApplicationNo20101) AS NotifyApplicationNo20101, SUM(Temp01.notifyUnitPremium20101) as notifyUnitPremium20101, SUM(0) as RejectApplicationNo30191, SUM(0) as RejectUnitPremium30191, COUNT(Temp01.RejectApplicationNo20101) as RejectApplicationNo20101, SUM(Temp01.RejectUnitPremium20101) as RejectUnitPremium20101, SUM(Temp01.Year01) AS Year01, SUM(Temp01.Year02) AS Year02, SUM(Temp01.Year03) AS Year03, SUM(Temp01.Year04) AS Year04, SUM(Temp01.Year05) AS Year05, SUM(Temp01.Year06) AS Year06 FROM Division D LEFT JOIN ( SELECT BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, (PremiumPerMonth*ApplicationMonth) AS UnitPremium20101, ApplicationNo20101 AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, null AS notifyUnitPremium20101, null AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, (PremiumPerMonth*ApplicationMonth) AS Year01, 0 AS Year02, 0 AS Year03, 0 AS Year04, 0 AS Year05, 0 AS Year06 FROM #ResultTemp101 UNION ALL SELECT BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20101, null AS notifyUnitPremium30191, null AS NotifyApplicationNo30191, (PremiumPerMonth*ApplicationMonth) AS notifyUnitPremium20101, NotifyApplicationNo20101 AS NotifyApplicationNo20101, null AS RejectApplicationNo30191, null AS RejectUnitPremium30191, null AS RejectApplicationNo20101, null AS RejectUnitPremium20101, 0 AS Year01, 0 AS Year02, 0 AS Year03, (PremiumPerMonth*ApplicationMonth) AS Year04, 0 AS Year05, 0 AS Year06 FROM #ResultTemp201 UNION ALL SELECT G.BranchCode, null AS UnitPremium30191, null AS ApplicationNo30191, null AS UnitPremium20101, null AS ApplicationNo20101, null as notifyUnitPremium30191, null AS NotifyApplicationNo30191, null as notifyUnitPremium20101, null AS NotifyApplicationNo20101, null as RejectApplicationNo30191, null as RejectUnitPremium30191, G.ApplicationNo as RejectApplicationNo20101, G.UnitPremium as RejectUnitPremium20101, 0 AS Year01, 0 AS Year02, 0 AS Year03, 0 AS Year04, 0 AS Year05, 0 AS Year06 FROM PersonalInsuranceSaving G WHERE (G.ApproveStatus > 2) AND (G.ApproveDate>='01/04/2015 00:00:00.000' AND G.ApproveDate<='30/04/2015 23:59:59.997') ) AS Temp01 ON Temp01.[BranchCode] = D.DivisionCode WHERE D.DivisionArea <> 0 AND SUBSTRING(D.DivisionCodeHR,5,1) <> 'A' AND SUBSTRING(D.DivisionCodeHR,3,2) <> '00' GROUP BY D.DivisionArea, D.UpperDivisionName, D.DivisionName WITH ROLLUP ORDER BY CAST(D.DivisionArea AS INT) , D.UpperDivisionName, D.DivisionName DROP TABLE #ResultALL01 DROP TABLE #ResultALL02 DROP TABLE #ResultTemp101 DROP TABLE #ResultTemp201 